#!/bin/bash

. ~/venv/bin/activate

adps_time_select ~/web-server.csv ~/web-server.ad.csv e -3h
ERRORS=`adps_anomaly_detector /home/os/web-server.ad.csv Errors 5`
echo "Errors: $ERRORS"

if [ $ERRORS -ge 10 ]
then
        curl http://eden-1:5000/time_table/-2h > ~/web-server1.time_table.csv 2>/dev/null && \
        curl http://eden-2:5000/time_table/-2h > ~/web-server2.time_table.csv 2>/dev/null && \
        CRONTAB=`mktemp /tmp/web-server.crontab.XXXXXXXXXX` && \
        crontab -l | grep -v 'autogenerated web-server switcher' > $CRONTAB && \
        adps_switcher /usr/local/bin/switch_web-server.sh ~/web-server1.time_table.csv ~/web-server2.time_table.csv >> $CRONTAB && \
        crontab $CRONTAB #&& \
        #rm $CRONTAB
fi
